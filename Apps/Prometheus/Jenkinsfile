pipeline {
  agent any

  environment {
    KUBE_NAMESPACE = 'monitoring'
    HELM_RELEASE   = 'monitoring'
    HELM_CHART     = 'prometheus-community/kube-prometheus-stack'
    HELM_REPO      = 'https://prometheus-community.github.io/helm-charts'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Deploy Monitoring Stack') {
      steps {
        dir('Apps/Prometheus') {
          withCredentials([string(credentialsId: 'grafana-admin-pass', variable: 'GRAFANA_ADMIN_PASS')]) {
            sh '''
              set -euo pipefail

              helm repo add prometheus-community "$HELM_REPO" >/dev/null 2>&1 || true
              helm repo update

              # Idempotent namespace creation
              kubectl create namespace "$KUBE_NAMESPACE" --dry-run=client -o yaml | kubectl apply -f -

              helm upgrade --install "$HELM_RELEASE" "$HELM_CHART" \
                --namespace "$KUBE_NAMESPACE" \
                --create-namespace \
                --set grafana.adminPassword="$GRAFANA_ADMIN_PASS" \
                --set prometheus.prometheusSpec.retention="7d" \
                --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage="10Gi"

              kubectl get pods -n "$KUBE_NAMESPACE"
              kubectl get svc  -n "$KUBE_NAMESPACE"
            '''
          }
        }
      }
    }
  }

  post {
    success {
      echo "Prometheus and Grafana deployed successfully in namespace ${env.KUBE_NAMESPACE}"
    }
    failure {
      echo "Deployment failed. Check logs above."
    }
  }
}
